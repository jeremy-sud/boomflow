name: "ğŸ… BOOMFLOW Auto-Award (Daily)"

on:
  # Run daily at 6:00 AM UTC (midnight Costa Rica)
  schedule:
    - cron: '0 6 * * *'
  
  # Allow manual execution
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Only verify, do not award badges'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  auto-award:
    name: "ğŸ¯ Verify and Award Badges"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout BOOMFLOW
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Show registered users
        run: |
          echo "ğŸ‘¥ Registered users in BOOMFLOW:"
          ls -la users/
          echo ""
          echo "ğŸ“‹ Current collaborators:"
          for f in users/*.json; do
            username=$(jq -r '.username' "$f")
            displayName=$(jq -r '.displayName // .username' "$f")
            badges=$(jq '.badges | length' "$f")
            echo "   - @$username ($displayName) - $badges badges"
          done
      
      - name: Run Auto-Award
        id: auto_award
        env:
          # GITHUB_TOKEN: Built-in Actions token, scoped to this repository.
          # Used by auto-award.js to read commit/PR/review stats from the GitHub API.
          # No need for a Personal Access Token (PAT) â€” the default token has sufficient read access.
          # For cross-repo monitoring, set BOOMFLOW_REPOS env var and use a PAT with repo scope.
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRY_RUN: ${{ inputs.dry_run || 'false' }}
        run: |
          echo "ğŸ… Starting auto-award system..."
          echo ""
          
          node scripts/auto-award.js
          
          echo ""
          echo "âœ… Process completed"
      
      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain users/) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ Changes detected in user files"
            git diff --stat users/
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes to commit"
          fi
      
      - name: Commit and Push badges
        if: steps.changes.outputs.has_changes == 'true' && inputs.dry_run != 'true'
        run: |
          git config user.name "BOOMFLOW Auto-Award"
          git config user.email "boomflow@ursol.com"
          
          # Get summary of awarded badges
          SUMMARY=$(git diff --name-only users/ | xargs -I {} basename {} .json | tr '\n' ', ' | sed 's/,$//')
          
          git add users/
          git commit -m "ğŸ… Auto-award: Badges awarded automatically

          Updated users: $SUMMARY
          Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          Workflow: ${{ github.run_id }}
          
          ğŸ¤– Automatically awarded by BOOMFLOW Auto-Award System"
          
          git push
          
          echo "âœ… Changes pushed successfully"
      
      - name: Workflow summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š WORKFLOW SUMMARY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“… Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”„ Run ID: ${{ github.run_id }}"
          echo "ğŸ‘¤ Trigger: ${{ github.event_name }}"
          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… Status: Badges awarded and synced"
          else
            echo "â„¹ï¸ Status: No new badges to award"
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
