name: "ğŸ›¡ï¸ BOOMFLOW Badge Protection"

on:
  pull_request:
    paths:
      - 'users/**'
      - 'config/admins.json'
  push:
    paths:
      - 'users/**'
      - 'config/admins.json'

jobs:
  validate-badge-permissions:
    name: "ğŸ” Validar Permisos de Medallas"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Validate Badge Changes
        id: validate
        run: |
          echo "ğŸ›¡ï¸ BOOMFLOW Badge Protection System"
          echo "===================================="
          
          # Cargar lista de administradores
          ADMINS=$(cat config/admins.json | jq -r '.admins[].username' | tr '\n' '|' | sed 's/|$//')
          echo "ğŸ“‹ Administradores autorizados: $(echo $ADMINS | tr '|' ', ')"
          
          # Obtener el autor del cambio
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            AUTHOR="${{ github.event.pull_request.user.login }}"
            echo "ğŸ‘¤ Autor del PR: $AUTHOR"
          else
            AUTHOR="${{ github.actor }}"
            echo "ğŸ‘¤ Autor del push: $AUTHOR"
          fi
          
          # Verificar si el autor es administrador
          if echo "$AUTHOR" | grep -qE "^($ADMINS)$"; then
            echo "âœ… $AUTHOR es un administrador autorizado"
            echo "authorized=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ ERROR: $AUTHOR NO estÃ¡ autorizado para modificar medallas"
            echo "authorized=false" >> $GITHUB_OUTPUT
            echo ""
            echo "ğŸš« Solo los siguientes usuarios pueden otorgar medallas:"
            cat config/admins.json | jq -r '.admins[] | "   - \(.username) (\(.displayName))"'
            echo ""
            echo "ğŸ“§ Si crees que esto es un error, contacta a un administrador de Sistemas Ursol."
            exit 1
          fi
      
      - name: Validate Badge Data Structure
        if: steps.validate.outputs.authorized == 'true'
        run: |
          echo "ğŸ” Validando estructura de datos de medallas..."
          
          # Verificar archivos de usuario modificados
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- 'users/*.json' 2>/dev/null || echo "")
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- 'users/*.json' 2>/dev/null || echo "")
          fi
          
          if [ -n "$CHANGED_FILES" ]; then
            echo "ğŸ“ Archivos de usuario modificados:"
            echo "$CHANGED_FILES"
            
            for file in $CHANGED_FILES; do
              if [ -f "$file" ]; then
                echo ""
                echo "ğŸ“„ Validando $file..."
                
                # Verificar JSON vÃ¡lido
                if ! jq empty "$file" 2>/dev/null; then
                  echo "âŒ JSON invÃ¡lido en $file"
                  exit 1
                fi
                
                # Verificar estructura requerida
                if ! jq -e '.username' "$file" > /dev/null 2>&1; then
                  echo "âŒ Campo 'username' requerido en $file"
                  exit 1
                fi
                
                if ! jq -e '.badges | type == "array"' "$file" > /dev/null 2>&1; then
                  echo "âŒ Campo 'badges' debe ser un array en $file"
                  exit 1
                fi
                
                # Verificar que cada badge tenga awardedBy
                BADGES_WITHOUT_AWARDER=$(jq '[.badges[] | select(.awardedBy == null)] | length' "$file")
                if [ "$BADGES_WITHOUT_AWARDER" -gt 0 ]; then
                  echo "âš ï¸  Advertencia: $BADGES_WITHOUT_AWARDER medalla(s) sin campo 'awardedBy' en $file"
                fi
                
                echo "âœ… $file vÃ¡lido"
              fi
            done
          fi
          
          echo ""
          echo "âœ… ValidaciÃ³n completa"
      
      - name: Log Badge Changes
        if: steps.validate.outputs.authorized == 'true'
        run: |
          echo "ğŸ“Š Registrando cambios de medallas..."
          echo ""
          echo "ğŸ• Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ‘¤ Modificado por: ${{ github.actor }}"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          echo "ğŸ“ Evento: ${{ github.event_name }}"
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "ğŸ”€ PR: #${{ github.event.pull_request.number }}"
          fi
