name: "ğŸ›¡ï¸ BOOMFLOW Badge Protection"

on:
  pull_request:
    paths:
      - 'users/**'
      - 'config/admins.json'
  push:
    paths:
      - 'users/**'
      - 'config/admins.json'

jobs:
  validate-badge-permissions:
    name: "ğŸ” Validate Badge Permissions"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Validate Badge Changes
        id: validate
        run: |
          echo "ğŸ›¡ï¸ BOOMFLOW Badge Protection System"
          echo "===================================="
          
          # Load list of administrators
          ADMINS=$(cat config/admins.json | jq -r '.admins[].username' | tr '\n' '|' | sed 's/|$//')
          echo "ğŸ“‹ Authorized administrators: $(echo $ADMINS | tr '|' ', ')"
          
          # Allowed automated systems
          AUTO_SYSTEMS="github-actions|github-actions\[bot\]|BOOMFLOW Auto-Award"
          echo "ğŸ¤– Allowed automated systems: github-actions[bot]"
          
          # Get the change author
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            AUTHOR="${{ github.event.pull_request.user.login }}"
            echo "ğŸ‘¤ PR author: $AUTHOR"
          else
            AUTHOR="${{ github.actor }}"
            echo "ğŸ‘¤ Push author: $AUTHOR"
          fi
          
          # Check if it's the auto-award system
          if echo "$AUTHOR" | grep -qiE "^($AUTO_SYSTEMS)$"; then
            echo "ğŸ¤– Change made by BOOMFLOW automated system"
            echo "âœ… Auto-award system authorized"
            echo "authorized=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if the author is an administrator
          if echo "$AUTHOR" | grep -qE "^($ADMINS)$"; then
            echo "âœ… $AUTHOR is an authorized administrator"
            echo "authorized=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ ERROR: $AUTHOR is NOT authorized to modify badges"
            echo "authorized=false" >> $GITHUB_OUTPUT
            echo ""
            echo "ğŸš« Only the following users can award badges:"
            cat config/admins.json | jq -r '.admins[] | "   - \(.username) (\(.displayName))"'
            echo ""
            echo "ğŸ“§ If you believe this is an error, contact a Sistemas Ursol administrator."
            exit 1
          fi
      
      - name: Validate Badge Data Structure
        if: steps.validate.outputs.authorized == 'true'
        run: |
          echo "ğŸ” Validating badge data structure..."
          
          # Check modified user files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- 'users/*.json' 2>/dev/null || echo "")
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- 'users/*.json' 2>/dev/null || echo "")
          fi
          
          if [ -n "$CHANGED_FILES" ]; then
            echo "ğŸ“ Modified user files:"
            echo "$CHANGED_FILES"
            
            for file in $CHANGED_FILES; do
              if [ -f "$file" ]; then
                echo ""
                echo "ğŸ“„ Validating $file..."
                
                # Check for valid JSON
                if ! jq empty "$file" 2>/dev/null; then
                  echo "âŒ Invalid JSON in $file"
                  exit 1
                fi
                
                # Check required structure
                if ! jq -e '.username' "$file" > /dev/null 2>&1; then
                  echo "âŒ Field 'username' required in $file"
                  exit 1
                fi
                
                if ! jq -e '.badges | type == "array"' "$file" > /dev/null 2>&1; then
                  echo "âŒ Field 'badges' must be an array in $file"
                  exit 1
                fi
                
                # Check that each badge has awardedBy
                BADGES_WITHOUT_AWARDER=$(jq '[.badges[] | select(.awardedBy == null)] | length' "$file")
                if [ "$BADGES_WITHOUT_AWARDER" -gt 0 ]; then
                  echo "âš ï¸  Warning: $BADGES_WITHOUT_AWARDER badge(s) without 'awardedBy' field in $file"
                fi
                
                echo "âœ… $file valid"
              fi
            done
          fi
          
          echo ""
          echo "âœ… Validation complete"
      
      - name: Log Badge Changes
        if: steps.validate.outputs.authorized == 'true'
        run: |
          echo "ğŸ“Š Logging badge changes..."
          echo ""
          echo "ğŸ• Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ‘¤ Modified by: ${{ github.actor }}"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          echo "ğŸ“ Event: ${{ github.event_name }}"
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "ğŸ”€ PR: #${{ github.event.pull_request.number }}"
          fi
