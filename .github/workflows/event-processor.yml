name: "ğŸ¯ BOOMFLOW Event Processor"

on:
  # === PULL REQUESTS ===
  pull_request:
    types: [opened, closed]
  
  # === CODE REVIEWS ===
  pull_request_review:
    types: [submitted]
  
  # === ISSUES ===
  issues:
    types: [opened, closed]
  
  # === RELEASES ===
  release:
    types: [published]
  
  # === TambiÃ©n ejecutar con push (para tracking de commits) ===
  push:
    branches: [main]
  
  # === Manual trigger para testing ===
  workflow_dispatch:
    inputs:
      test_user:
        description: 'Usuario para simular evento'
        required: false
        default: 'jeremy-sud'

permissions:
  contents: write

jobs:
  process-event:
    name: "ğŸ… Procesar Evento â†’ Medallas"
    runs-on: ubuntu-latest
    
    # No ejecutar para bots
    if: github.actor != 'dependabot[bot]' && github.actor != 'github-actions[bot]'
    
    steps:
      - name: Checkout BOOMFLOW
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Determinar tipo de evento
        id: event_type
        run: |
          EVENT_NAME="${{ github.event_name }}"
          ACTION="${{ github.event.action }}"
          
          echo "ğŸ“ Evento: $EVENT_NAME"
          echo "ğŸ”„ AcciÃ³n: $ACTION"
          
          # Construir el tipo de evento completo
          if [ "$EVENT_NAME" == "pull_request" ]; then
            if [ "$ACTION" == "closed" ] && [ "${{ github.event.pull_request.merged }}" == "true" ]; then
              EVENT_TYPE="pull_request.merged"
            else
              EVENT_TYPE="pull_request.$ACTION"
            fi
          elif [ "$EVENT_NAME" == "pull_request_review" ]; then
            EVENT_TYPE="pull_request_review.$ACTION"
          elif [ "$EVENT_NAME" == "issues" ]; then
            EVENT_TYPE="issues.$ACTION"
          elif [ "$EVENT_NAME" == "release" ]; then
            EVENT_TYPE="release.$ACTION"
          elif [ "$EVENT_NAME" == "push" ]; then
            EVENT_TYPE="push"
          else
            EVENT_TYPE="$EVENT_NAME"
          fi
          
          echo "event_type=$EVENT_TYPE" >> $GITHUB_OUTPUT
          echo "âœ… Tipo de evento: $EVENT_TYPE"
      
      - name: Mostrar informaciÃ³n del evento
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“‹ INFORMACIÃ“N DEL EVENTO"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ¯ Evento: ${{ steps.event_type.outputs.event_type }}"
          echo "ğŸ‘¤ Actor: ${{ github.actor }}"
          echo "ğŸ“¦ Repo: ${{ github.repository }}"
          echo "ğŸ”€ Ref: ${{ github.ref }}"
          
          # Info especÃ­fica por tipo de evento
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "ğŸ“ PR: #${{ github.event.pull_request.number }}"
            echo "ğŸ“Œ TÃ­tulo: ${{ github.event.pull_request.title }}"
            echo "ğŸ‘¤ Autor: ${{ github.event.pull_request.user.login }}"
            echo "ğŸ”€ Merged: ${{ github.event.pull_request.merged }}"
          elif [ "${{ github.event_name }}" == "pull_request_review" ]; then
            echo "ğŸ“ PR: #${{ github.event.pull_request.number }}"
            echo "ğŸ‘¤ Reviewer: ${{ github.event.review.user.login }}"
            echo "ğŸ“Š Estado: ${{ github.event.review.state }}"
          elif [ "${{ github.event_name }}" == "issues" ]; then
            echo "ğŸ“ Issue: #${{ github.event.issue.number }}"
            echo "ğŸ“Œ TÃ­tulo: ${{ github.event.issue.title }}"
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: Procesar evento y otorgar medallas
        id: process
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ… Procesando evento..."
          node scripts/process-event.js "${{ steps.event_type.outputs.event_type }}"
      
      - name: Verificar cambios
        id: changes
        run: |
          if [[ -n $(git status --porcelain users/) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ Se detectaron cambios en archivos de usuarios:"
            git diff --stat users/
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No hay cambios para commitear"
          fi
      
      - name: Commit y Push medallas
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "BOOMFLOW Bot"
          git config user.email "boomflow@ursol.com"
          
          # Info del evento para el commit
          EVENT_TYPE="${{ steps.event_type.outputs.event_type }}"
          ACTOR="${{ github.actor }}"
          
          git add users/
          git commit -m "ğŸ… Webhook: Medallas otorgadas por $EVENT_TYPE
          
          Actor: @$ACTOR
          Evento: $EVENT_TYPE
          Workflow Run: ${{ github.run_id }}
          
          ğŸ¤– Otorgado automÃ¡ticamente por BOOMFLOW Event Processor"
          
          git push
          
          echo "âœ… Medallas pusheadas exitosamente"
      
      - name: Resumen
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š RESUMEN"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… Medallas otorgadas y sincronizadas"
          else
            echo "â„¹ï¸ Sin nuevas medallas para este evento"
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
