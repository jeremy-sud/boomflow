name: "ğŸ¯ BOOMFLOW Event Processor"

on:
  # === PULL REQUESTS ===
  pull_request:
    types: [opened, closed]
  
  # === CODE REVIEWS ===
  pull_request_review:
    types: [submitted]
  
  # === ISSUES ===
  issues:
    types: [opened, closed]
  
  # === RELEASES ===
  release:
    types: [published]
  
  # === Also run on push (for commit tracking) ===
  push:
    branches: [main]
  
  # === Manual trigger for testing ===
  workflow_dispatch:
    inputs:
      test_user:
        description: 'User to simulate event'
        required: false
        default: 'jeremy-sud'

permissions:
  contents: write

jobs:
  process-event:
    name: "ğŸ… Process Event â†’ Badges"
    runs-on: ubuntu-latest
    
    # Don't run for bots
    if: github.actor != 'dependabot[bot]' && github.actor != 'github-actions[bot]'
    
    steps:
      - name: Checkout BOOMFLOW
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Determine event type
        id: event_type
        run: |
          EVENT_NAME="${{ github.event_name }}"
          ACTION="${{ github.event.action }}"
          
          echo "ğŸ“ Event: $EVENT_NAME"
          echo "ğŸ”„ Action: $ACTION"
          
          # Build the full event type
          if [ "$EVENT_NAME" == "pull_request" ]; then
            if [ "$ACTION" == "closed" ] && [ "${{ github.event.pull_request.merged }}" == "true" ]; then
              EVENT_TYPE="pull_request.merged"
            else
              EVENT_TYPE="pull_request.$ACTION"
            fi
          elif [ "$EVENT_NAME" == "pull_request_review" ]; then
            EVENT_TYPE="pull_request_review.$ACTION"
          elif [ "$EVENT_NAME" == "issues" ]; then
            EVENT_TYPE="issues.$ACTION"
          elif [ "$EVENT_NAME" == "release" ]; then
            EVENT_TYPE="release.$ACTION"
          elif [ "$EVENT_NAME" == "push" ]; then
            EVENT_TYPE="push"
          else
            EVENT_TYPE="$EVENT_NAME"
          fi
          
          echo "event_type=$EVENT_TYPE" >> $GITHUB_OUTPUT
          echo "âœ… Event type: $EVENT_TYPE"
      
      - name: Show event information
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“‹ EVENT INFORMATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ¯ Event: ${{ steps.event_type.outputs.event_type }}"
          echo "ğŸ‘¤ Actor: ${{ github.actor }}"
          echo "ğŸ“¦ Repo: ${{ github.repository }}"
          echo "ğŸ”€ Ref: ${{ github.ref }}"
          
          # Specific info per event type
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "ğŸ“ PR: #${{ github.event.pull_request.number }}"
            echo "ğŸ“Œ TÃ­tulo: ${{ github.event.pull_request.title }}"
            echo "ğŸ‘¤ Autor: ${{ github.event.pull_request.user.login }}"
            echo "ğŸ”€ Merged: ${{ github.event.pull_request.merged }}"
          elif [ "${{ github.event_name }}" == "pull_request_review" ]; then
            echo "ğŸ“ PR: #${{ github.event.pull_request.number }}"
            echo "ğŸ‘¤ Reviewer: ${{ github.event.review.user.login }}"
            echo "ğŸ“Š Status: ${{ github.event.review.state }}"
          elif [ "${{ github.event_name }}" == "issues" ]; then
            echo "ğŸ“ Issue: #${{ github.event.issue.number }}"
            echo "ğŸ“Œ TÃ­tulo: ${{ github.event.issue.title }}"
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: Process event and award badges
        id: process
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ… Processing event..."
          node scripts/process-event.js "${{ steps.event_type.outputs.event_type }}"
      
      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain users/) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ Changes detected in user files:"
            git diff --stat users/
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes to commit"
          fi
      
      - name: Commit and Push badges
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "BOOMFLOW Bot"
          git config user.email "boomflow@ursol.com"
          
          # Event info for the commit
          EVENT_TYPE="${{ steps.event_type.outputs.event_type }}"
          ACTOR="${{ github.actor }}"
          
          git add users/
          git commit -m "ğŸ… Webhook: Badges awarded by $EVENT_TYPE
          
          Actor: @$ACTOR
          Event: $EVENT_TYPE
          Workflow Run: ${{ github.run_id }}
          
          ğŸ¤– Automatically awarded by BOOMFLOW Event Processor"
          
          git push
          
          echo "âœ… Badges pushed successfully"
      
      - name: Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š SUMMARY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… Badges awarded and synced"
          else
            echo "â„¹ï¸ No new badges for this event"
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
